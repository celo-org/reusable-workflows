---
name: 'Run Container Workflow'
on: 
  workflow_call:
    inputs:
      workload-id-provider:
        required: true
        type: string
      service-account:
        required: true
        type: string
      access-token-lifetime:
        description: "GCP token expiration timeout"
        required: false
        type: string
        default: "20m" 
      artifact-registry:
        required: true
        type: string
      tags:
        required: true
        type: string
      platforms:
        type: string
        default: "linux/amd64"
      context:
        required: true
        type: string
      file:
        required: false
        type: string
      build-args:
        required: false
        type: string
      provenance:
        required: false
        type: boolean
        default: true
      runs_on:
        default: "['ubuntu-latest']"
        type: string
        description: "github runner tags"
      timeout-minutes:
        default: 30
        type: number
        description: "Workflow timeout"
      environment:
        default: ''
        description: "Deployment environment in github"
        type: string
      debug_enabled:
        default: false
        required: false
        type: boolean
        description: "run tmate for troubleshooting"
        

jobs:
  auth-build-push-scan-container:
    # We can set a runs-on array in a text string and convert it with fromJson to an array here
    # This lets runs_on be specified at the calling level
    runs-on: ${{ fromJson(inputs.runs_on) }}
    # Time out the job if it takes too long so we're not burning minutes for some weird reason. Adjustable
    timeout-minutes: ${{ inputs.timeout-minutes }}
    # Leverage the protections and environment rulesets here. This will also print the URL
    # in the github actions tab on github if the deploy is successful
    environment:
      name: ${{ inputs.environment }}
      url: "https://${{ inputs.artifact-registry }}:${{inputs.tags}}"
    permissions: # Required for workload identity auth and push the trivy results to GitHub
      contents: read
      id-token: write
      security-events: write
    steps:
      - name: Harden Runner
        if: runner.environment == 'github-hosted'
        uses: step-security/harden-runner@v2
        with:
          # We can disable sudo but tmate requires it, so if debug is on enable sudo
          disable-sudo: ${{ !inputs.debug }}
          egress-policy: block
          allowed-endpoints: >
            SsH.tmAtE.io:22
            api.github.com:443
            auth.docker.io:443
            dl.google.com:443
            fulcio.sigstore.dev:443
            github.com:443
            iamcredentials.googleapis.com:443
            objects.githubusercontent.com:443
            production.cloudflare.docker.com:443
            raw.githubusercontent.com:443
            registry-1.docker.io:443
            rekor.sigstore.dev:443
            sts.googleapis.com:443
            tuf-repo-cdn.sigstore.dev:443
            us-west1-docker.pkg.dev:443

  
      - name: Setup tmate session
        uses: mxschmitt/action-tmate@e5c7151931ca95bad1c6f4190c730ecf8c7dde48
        if: inputs.debug_enabled == true 
        with:
          sudo: false
          detached: true
    
      - name: 'Checkout'
        uses: actions/checkout@v4

      - name: Split location and app names
        id: split
        env:
          REGISTRY: ${{ inputs.artifact-registry }}
        shell: bash
        run: |
            location=${REGISTRY%%/*}
            app_name=${REGISTRY##*/}
            echo "::debug::location=$location"
            echo "::debug::app_name=$app_name"
            echo "location=$location" >> $GITHUB_OUTPUT
            echo "app_name=$app_name" >> $GITHUB_OUTPUT

      - name: Authenticate to Google Cloud
        uses: celo-org/reusable-workflows/.github/actions/auth-gcp-artifact-registry@main
        with:
          workload-id-provider: ${{ inputs.workload-id-provider }}
          service-account: ${{ inputs.service-account }}
          access-token-lifetime: ${{ inputs.access-token-lifetime }}
          docker-gcp-registries: ${{ steps.split.outputs.location }}

      - name: Build, push and scan the container
        uses: celo-org/docker-build-composite-action@v1.0.0-alpha
        with:
          platforms: ${{ inputs.platforms }}
          registry: ${{ inputs.artifact-registry }}
          tags: ${{ inputs.tags }}
          context: ${{ inputs.context }}
          dockerfile: ${{ inputs.file }}
          build-args: ${{ inputs.build-args }}
          push: ${{ fromJSON(true) }}
